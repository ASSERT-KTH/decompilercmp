---
title: "Descriptive Analysis"
output: html_notebook
---

This notebook shows descriptive statistics of the results obtained with the decompilers. 

# Load required packages

```{r}
library(tidyverse)
library(VennDiagram)
library(venn)
theme_set(theme_bw())

# Set up a different colour palette
# library(RColorBrewer)
# ggplot <- function(...)
#     ggplot2::ggplot(...) + 
#   scale_color_discrete(palette = "Spectral") +
#   scale_color_brewer(palette = "Spectral") + 
#   scale_fill_brewer(palette = "Spectral")
```

# Read the dataset

```{r}
dataset <- read.csv("data/dataset.csv")
```

# General summary of the dataset

```{r}
summary(dataset)

# summary of numeric variables
dataset %>%
  filter(!is.na(distanceToOriginal) & !is.na(nbNodesOriginal) & nbNodesOriginal != 0) %>%
  dplyr::select(Decompiler, distanceToOriginal, nbNodesOriginal) %>%
  group_by(Decompiler) %>%
  summarise(
    min = min(distanceToOriginal/nbNodesOriginal),
    q25 = quantile(distanceToOriginal/nbNodesOriginal, 0.25),
    median = median(distanceToOriginal/nbNodesOriginal),
    q75 = quantile(distanceToOriginal/nbNodesOriginal, 0.75),
    max = max(distanceToOriginal/nbNodesOriginal),
    mean = mean(distanceToOriginal/nbNodesOriginal),
    sd = sd(distanceToOriginal/nbNodesOriginal)
  )

# summary of non-numeric variables
dataset$isRecompilable <- as.factor(dataset$isRecompilable)
dataset$passTests <- as.factor(dataset$passTests)

dataset %>%
  dplyr::select(Decompiler, isRecompilable, passTests) %>%
  group_by(Decompiler) %>%
  count(isRecompilable, passTests)
```

# What is the best decompiler?

### Distribution of distance to original

```{r}
# Distance to the original
dataset %>% 
  filter(!is.na(distanceToOriginal) & !is.na(nbNodesOriginal) & nbNodesOriginal != 0) %>% 
  ggplot(aes(Decompiler, distanceToOriginal/nbNodesOriginal)) +
  geom_boxplot() +
  scale_y_continuous(limits = c(0, 1)) +
  coord_flip()

ggsave(filename = "figures/distances.pdf", device="pdf", height = 4, width = 6,  units = c("in"))
```

### Distribution of recompilable and testable types per decompilers

```{r}
# Distribution of Recompilable Types for each Decompiler
dataset %>% 
  dplyr::select(Decompiler, isRecompilable) %>% 
  group_by(Decompiler) %>% 
  count(Recompilable = isRecompilable) %>% 
  ggplot(aes(Decompiler, n)) +
  geom_bar(aes(fill = Recompilable), position = "dodge", stat="identity") +
  ylab("Types") +
  ggtitle("Distribution of Recompilable Types for each Decompiler") + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

ggsave(filename = "figures/recompilable_decompilers.pdf", device="pdf", height = 4, width = 6,  units = c("in"))

# Distribution of tests results for each Decompiler
dataset %>% 
  dplyr::select(Decompiler, passTests) %>% 
  filter(!is.na(passTests)) %>% 
  group_by(Decompiler) %>% 
  count(PassTests = passTests) %>% 
  ggplot(aes(Decompiler, n)) +
  geom_bar(aes(fill = PassTests), position = "dodge", stat="identity") +
  ylab("Tests") +
  ggtitle("Distribution of Tests Results for each Decompiler") + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

ggsave(filename = "figures/testable_decompilers.pdf", device="pdf", height = 4, width = 6,  units = c("in"))


# Distribution of tests results for each Compiler
dataset %>%
  filter(Project != "commons-lang" & passTests == TRUE) %>% 
  dplyr::select(Decompiler, Compiler, passTests) %>%
  filter(!is.na(passTests)) %>%
  group_by(Decompiler, Compiler) %>%
  count(PassTests = passTests) %>%
  ggplot(aes(Decompiler, n, fill = Compiler)) +
  geom_bar(position = "dodge", stat = "identity") +
  ylab("Tests") +
  ggtitle("Distribution of Tests Results for each Decompiler") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

ggsave(filename = "figures/testable_decompilers.pdf", device="pdf", height = 4, width = 6,  units = c("in"))
```

### Distribution of recompilable and testable types per projects

```{r}
# Distribution of Recompilable Types for each Project
dataset %>%
  dplyr::select(Project, Decompiler, isRecompilable) %>%
  group_by(Project, Decompiler) %>%
  count(Decompilable = isRecompilable) %>%
  ggplot(aes(Decompiler, n)) +
  geom_bar(aes(fill = Project), position = "dodge", stat = "identity") +
  ylab("# Types") +
  ggtitle("Distribution of Recompilation of Types for each Project") + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_grid(Decompilable ~ .)
  
ggsave(filename = "figures/recompilable_projects.pdf", device="pdf", height = 5, width = 8,  units = c("in"))

# Distribution of Testable Types for each Project
dataset %>%
  dplyr::select(Project, Decompiler, passTests) %>%
  filter(!is.na(passTests)) %>% 
  group_by(Project, Decompiler) %>%
  count(Testable = passTests) %>%
  ggplot(aes(Decompiler, n)) +
  geom_bar(aes(fill = Project), position = "dodge", stat = "identity") +
  ylab("# Types") +
  ggtitle("Distribution of Tests Results for each Project") + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_grid(Testable ~ .)
  
ggsave(filename = "figures/testable_projects.pdf", device="pdf", height = 5, width = 8,  units = c("in"))
```

### Distribution of recompilable and testable ratios per projects

```{r}
# Distribution of Recompilable Types for each Project
dataset %>%
  dplyr::select(Project, Decompiler, isRecompilable) %>%
  group_by(Project, Decompiler) %>%
  count(Decompilable = isRecompilable) %>%
  mutate(true_ratio = n / sum(n)) %>%
  ggplot(aes(Decompiler, true_ratio)) +
  geom_bar(aes(fill = Project), position = "dodge", stat = "identity") +
  ylab("Ratio") +
  ggtitle("Distribution of Recompilation Frequencies of each Project") + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_grid(Decompilable ~ .)
  
ggsave(filename = "figures/recompilable_projects_ratios.pdf", device="pdf", height = 5, width = 8,  units = c("in"))

# Distribution of Testable Types for each Project
dataset %>%
  dplyr::select(Project, Decompiler, passTests) %>%
  filter(!is.na(passTests)) %>% 
  group_by(Project, Decompiler) %>%
  count(Testable = passTests) %>%
  mutate(true_ratio = n / sum(n)) %>%
  ggplot(aes(Decompiler, true_ratio)) +
  geom_bar(aes(fill = Project), position = "dodge", stat = "identity") +
  ylab("Ratio") +
  ggtitle("Distribution of Tests Results Frequencies for each Project") + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_grid(Testable ~ .)
  
ggsave(filename = "figures/testable_projects_ratios.pdf", device="pdf", height = 5, width = 8,  units = c("in"))
```

### Decompilers that produce recompilable types which do not pass the tests (false positives)

```{r}
dataset %>%
  filter(isRecompilable == TRUE & passTests == FALSE) %>% 
  count(Decompiler, Project) %>% 
  ggplot(aes(x = reorder(Decompiler, -n), y = n, fill = Project)) +
  geom_col() +
  xlab("Decompiler") +
  ylab("# Types") +
  ggtitle("Projects Producing Recompilable Types Which do not Pass the Tests") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) 

ggsave(filename = "figures/projects_recompilable_types_fail_tests.pdf", device="pdf", height = 5, width = 8,  units = c("in"))

# Plot Categories of Outputs for Each Decompiler
dataset %>%
  dplyr::select(Decompiler, Project, isRecompilable, passTests) %>%
  filter(is.na(passTests) == FALSE) %>%
  mutate(Category = ifelse(
    isRecompilable == FALSE,
    "NOT R",
    ifelse(
      isRecompilable == TRUE & passTests == FALSE,
      "R AND NOT P",
      ifelse(isRecompilable == TRUE & passTests == TRUE,
             "R AND P",
             "NA")
    )
  )) %>%
  group_by(Decompiler, Project) %>%
  count(Categories = Category) %>%
  ggplot(aes(x = reorder(Decompiler, -n), y = n)) +
  geom_bar(aes(fill = Project), position = "stack", stat = "identity") +
  stat_summary(fun.y = sum, aes(label = ..y.., group = Categories), geom = "text", vjust = -.2) +
  ylim(0, 2500) +
  xlab("Decompiler") +
  ylab("# Types") +
  facet_grid(Categories ~ .) +
  ggtitle("Categories of Ouputs For Each Decompiler") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) 

ggsave(filename = "figures/recompilation_categories_results.pdf", device="pdf", height = 5, width = 8,  units = c("in"))
```

Plot the most problematic types

```{r}
# Arrange the recompilable types for which the tests fail 
tmp1 <- dataset %>%
  filter(Compiler == "javac") %>% 
  filter(isRecompilable == TRUE & passTests == FALSE) %>%
  group_by(Class) %>%
  count() %>%
  arrange(desc(n)) %>%
  filter(n > 1) %>% 
  dplyr::rename(TF = n)

tmp2 <- dataset %>%
  filter(Compiler == "javac") %>% 
  filter(isRecompilable == FALSE & passTests == FALSE) %>%
  group_by(Class) %>%
  count() %>%
  arrange(desc(n)) %>% 
  dplyr::rename(FF = n)
  
tmp3 <- dataset %>%
  filter(Compiler == "javac") %>% 
  filter(isRecompilable == TRUE & passTests == TRUE) %>%
  group_by(Class) %>%
  count() %>%
  arrange(desc(n)) %>% 
  dplyr::rename(TT = n)

problematicClasses <- dplyr::left_join(dplyr::left_join(tmp1, tmp2, by="Class"), tmp3, by = "Class") %>% 
  replace_na(list(TF = 0, FF = 0, TT = 0)) %>% 
  mutate(Metaproblem = ifelse((TF + FF) == 8, TRUE, FALSE))

table(problematicClasses$Metaproblem)

# Sort types by number of decompilers that fail
tmp <- tmp[order(tmp$n),]
tmp$Class <- factor(tmp$Class, levels = tmp$Class) 
  
tmp %>% ggplot(aes(Class, n)) +
  geom_point(stat = 'identity', fill = "black", size = 2)  +
  geom_segment(aes(
    y = 0,
    x = Class,
    yend = n,
    xend = Class
  ),
  color = "black") +
  ylab("# Decompilers that Fail Tests") +
  xlab("Types") +
  ggtitle("Recompilable Types for Which the Tests Fail") +
  coord_flip()

ggsave(filename = "figures/recompilable_types_fail_tests.pdf", device="pdf", height = 5, width = 8,  units = c("in"))
```